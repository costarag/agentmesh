generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MessageRole {
  USER
  ASSISTANT
  TOOL
}

enum MessagePartType {
  TEXT
  REASONING
  TOOL
  STEP_START
  STEP_FINISH
  ERROR
  OTHER
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum IngestionSourceType {
  CLAUDE
  OPENCODE
}

enum IngestionRunStatus {
  RUNNING
  SUCCESS
  FAILED
  PARTIAL
}

model Workspace {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  createdAt DateTime  @default(now())
  sessions  Session[]
}

model SourceTool {
  id              String           @id @default(cuid())
  name            String
  slug            String           @unique
  createdAt       DateTime         @default(now())
  sessions        Session[]
  metricSnapshots MetricSnapshot[]
}

model Session {
  id                String           @id @default(cuid())
  workspaceId       String
  sourceToolId      String
  externalSessionId String?
  sourceSessionPath String?
  title             String
  summary           String?
  startedAt         DateTime?
  endedAt           DateTime?
  lastActivityAt    DateTime?
  importSource      String?
  importedAt        DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  workspace         Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  sourceTool        SourceTool       @relation(fields: [sourceToolId], references: [id], onDelete: Restrict)
  messages          Message[]
  messageParts      MessagePart[]
  artifacts         Artifact[]
  tasks             Task[]
  tags              SessionTag[]
  metricSnapshots   MetricSnapshot[]

  @@unique([sourceToolId, externalSessionId])
  @@index([workspaceId])
  @@index([sourceToolId])
  @@index([externalSessionId])
  @@index([lastActivityAt])
}

model Message {
  id                String       @id @default(cuid())
  sessionId         String
  externalMessageId String?
  role              MessageRole
  modelProvider     String?
  modelId           String?
  content           String
  metadata          Json?
  promptTokens      Int?
  completionTokens  Int?
  totalTokens       Int?
  sourceTimestamp   DateTime?
  ordinal           Int
  createdAt         DateTime     @default(now())
  session           Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  parts             MessagePart[]
  artifacts         Artifact[]
  tags              MessageTag[]

  @@unique([sessionId, externalMessageId])
  @@index([sessionId, ordinal])
  @@index([modelProvider, modelId])
  @@index([sourceTimestamp])
}

model MessagePart {
  id             String          @id @default(cuid())
  sessionId      String
  messageId      String
  externalPartId String?
  partType       MessagePartType
  text           String?
  data           Json?
  sourceTimestamp DateTime?
  ordinal        Int
  createdAt      DateTime        @default(now())
  session        Session         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  message        Message         @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, externalPartId])
  @@index([sessionId, ordinal])
  @@index([partType])
  @@index([sourceTimestamp])
}

model Artifact {
  id        String   @id @default(cuid())
  sessionId String
  messageId String?
  type      String
  name      String
  content   String
  metadata  Json?
  createdAt DateTime @default(now())
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  message   Message? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([messageId])
}

model Task {
  id          String       @id @default(cuid())
  sessionId   String
  title       String
  description String?
  status      TaskStatus   @default(OPEN)
  priority    TaskPriority @default(MEDIUM)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  session     Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model Tag {
  id          String       @id @default(cuid())
  name        String
  slug        String       @unique
  createdAt   DateTime     @default(now())
  sessionTags SessionTag[]
  messageTags MessageTag[]
}

model SessionTag {
  sessionId String
  tagId     String
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([sessionId, tagId])
}

model MessageTag {
  messageId String
  tagId     String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([messageId, tagId])
}

model MetricSnapshot {
  id               String      @id @default(cuid())
  sessionId        String
  sourceToolId     String?
  totalTokens      Int         @default(0)
  promptTokens     Int         @default(0)
  completionTokens Int         @default(0)
  estimatedCost    Decimal     @default(0) @db.Decimal(12, 6)
  recordedAt       DateTime    @default(now())
  session          Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sourceTool       SourceTool? @relation(fields: [sourceToolId], references: [id], onDelete: SetNull)

  @@index([sessionId])
}

model PromptTemplate {
  id          String          @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  versions    PromptVersion[]
}

model PromptVersion {
  id         String         @id @default(cuid())
  templateId String
  version    Int
  content    String
  createdAt  DateTime       @default(now())
  template   PromptTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, version])
}

model IngestionSource {
  id              String              @id @default(cuid())
  key             String              @unique
  type            IngestionSourceType
  name            String
  isEnabled       Boolean             @default(true)
  rootPath        String?
  dbPath          String?
  pollIntervalSec Int                 @default(30)
  lookbackDays    Int                 @default(30)
  lastRunAt       DateTime?
  lastSuccessAt   DateTime?
  lastErrorAt     DateTime?
  statusMessage   String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  checkpoints     IngestionCheckpoint[]
  runs            IngestionRun[]
  errors          IngestionError[]
}

model IngestionCheckpoint {
  id          String          @id @default(cuid())
  sourceId    String
  cursorKey   String
  cursorValue String
  updatedAt   DateTime        @updatedAt
  source      IngestionSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@unique([sourceId, cursorKey])
}

model IngestionRun {
  id              String             @id @default(cuid())
  sourceId        String
  mode            String
  status          IngestionRunStatus @default(RUNNING)
  startedAt       DateTime           @default(now())
  finishedAt      DateTime?
  scannedSessions Int                @default(0)
  upsertedSessions Int               @default(0)
  upsertedMessages Int               @default(0)
  upsertedParts   Int                @default(0)
  errorCount      Int                @default(0)
  note            String?
  source          IngestionSource    @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  errors          IngestionError[]

  @@index([sourceId, startedAt])
}

model IngestionError {
  id         String           @id @default(cuid())
  sourceId   String
  runId      String?
  cursorKey  String?
  code       String
  message    String
  payload    Json?
  createdAt  DateTime         @default(now())
  source     IngestionSource  @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  run        IngestionRun?    @relation(fields: [runId], references: [id], onDelete: SetNull)

  @@index([sourceId, createdAt])
  @@index([runId])
}
